<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penilaian Rakan Sebaya</title>
    <!-- 1. FONT DARI GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Pustaka untuk membaca fail Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- 2. GAYA CSS TERUS DI DALAM HTML -->
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #ccc;
            --error-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        #app {
            width: 100%;
            max-width: 600px; /* Lebarkan sedikit untuk jadual penilaian */
            background-color: var(--card-background);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease-in-out;
        }
        
        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            font-weight: 700;
        }
        
        h2 { margin-bottom: 0.5rem; }
        h3 { margin-bottom: 1.5rem; font-weight: 400; color: var(--label-color); }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--label-color);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
        }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }
        
        .message {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            display: none;
        }
        .message.error {
            color: var(--error-color);
            background-color: rgba(220, 53, 69, 0.1);
        }
        .message.success {
            color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.1);
        }

        /* Gaya untuk Jadual Penilaian */
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .evaluation-table th, .evaluation-table td {
            text-align: left;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        .evaluation-table th {
            font-weight: 500;
            color: var(--label-color);
        }
        .rating-group {
            display: flex;
            gap: 0.5rem;
        }
        
        /* [DIKEMASKINI] Gaya untuk butang skala penilaian */
        .rating-group .btn {
            flex: 1; /* Supaya semua butang sama besar */
            background-color: #e9ecef; /* Warna asal butang (tidak dipilih) */
            color: var(--secondary-color);
            border: 1px solid #dee2e6;
            margin-top: 0;
        }
        .rating-group .btn:hover {
            background-color: #dde2e7; /* Warna ketika tetikus di atasnya */
        }
        .rating-group .btn.selected {
            background-color: var(--primary-color); /* Warna apabila dipilih */
            color: white;
            border-color: var(--primary-color);
        }
        
        /* [BARU] Gaya untuk kotak kriteria */
        .criteria-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .criteria-box p {
            margin: 0 0 0.5rem 0;
        }
        .criteria-box p:last-child {
            margin-bottom: 0;
        }
        .criteria-box strong {
            color: var(--text-color);
        }

    </style>
</head>
<body>
    
    <div id="app">
        <!-- Kandungan aplikasi akan dimuatkan di sini -->
    </div>

    <!-- 3. SKRIP FIREBASE DAN LOGIK APLIKASI -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDoc, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // Konfigurasi Firebase Anda (TELAH DIKEMASKINI)
        const firebaseConfig = {
            apiKey: "AIzaSyAVDe2JccI_u6yIdgtDHHmOVMnqfzc7oDA",
            authDomain: "penilaian-ajk.firebaseapp.com",
            projectId: "penilaian-ajk",
            storageBucket: "penilaian-ajk.appspot.com",
            messagingSenderId: "409815374539",
            appId: "1:409815374539:web:e66da87200f959ae9d594e",
            measurementId: "G-T7KZYS3W0Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        console.log("Firebase berjaya dihubungkan dengan projek 'penilaian-ajk'!");

        const appContainer = document.getElementById('app');
        
        // Data sementara untuk proses penilaian
        let evaluationState = {};

        // =================================================================================
        // SOALAN-SOALAN PENILAIAN
        // =================================================================================
        const evaluationQuestions = [
            // Fasa 1
            "Sejauh manakah ahli ini terlibat secara aktif dalam sesi perbincangan dan menyumbang kepada perancangan tugas AJK?",
            "Adakah ahli ini menunjukkan inisiatif dalam mencadangkan idea atau mengambil tanggungjawab tanpa perlu disuruh?",
            "Sejauh manakah ahli ini berkomunikasi dengan jelas dan berkesan dengan ahli lain semasa fasa perancangan?",
            // Fasa 2
            "Adakah ahli ini melaksanakan tugas yang diamanahkan dengan cekap dan penuh tanggungjawab semasa aktiviti berlangsung?",
            "Sejauh manakah keupayaan ahli ini untuk kekal tenang dan membantu menyelesaikan sebarang masalah yang timbul secara tiba-tiba?",
            "Adakah ahli ini bekerjasama dengan baik, sedia membantu rakan lain, dan mengekalkan komunikasi yang positif?",
            "Adakah ahli ini menunjukkan sikap yang positif dan menjadi pendorong semangat kepada ahli AJK yang lain?",
            // Fasa 3
            "Adakah ahli ini turut serta dan komited dalam menyelesaikan tugasan selepas aktiviti (cth: mengemas)?",
            "Sejauh manakah ahli ini menyumbang dalam sesi post-mortem serta terbuka untuk memberi dan menerima maklum balas?"
        ];

        // =================================================================================
        // FUNGSI-FUNGSI PAPARAN (RENDER)
        // =================================================================================
        function renderRoleSelectionScreen() {
            appContainer.innerHTML = `
                <h1>Selamat Datang</h1>
                <h2>Sila pilih peranan anda:</h2>
                <button id="studentBtn" class="btn">Saya Pelajar</button>
                <button id="adminBtn" class="btn btn-secondary">Saya Admin</button>
            `;
            document.getElementById('studentBtn').addEventListener('click', renderStudentLoginScreen);
            document.getElementById('adminBtn').addEventListener('click', renderAdminLoginScreen);
        }

        function renderStudentLoginScreen() {
            appContainer.innerHTML = `
                <h2>Log Masuk Pelajar</h2>
                <div class="form-group">
                    <label for="noKP">No. Kad Pengenalan (tanpa '-')</label>
                    <input type="text" id="noKP" placeholder="Contoh: 980101101234">
                </div>
                <button id="loginBtn" class="btn">Log Masuk</button>
                <button id="backBtn" class="btn btn-secondary">Kembali</button>
                <p id="message" class="message error"></p>
            `;
            document.getElementById('loginBtn').addEventListener('click', handleStudentLogin);
            document.getElementById('backBtn').addEventListener('click', renderRoleSelectionScreen);
        }
        
        function renderAdminLoginScreen() {
             appContainer.innerHTML = `
                <h2>Log Masuk Admin</h2>
                <div class="form-group">
                    <label for="adminPass">Kata Laluan</label>
                    <input type="password" id="adminPass">
                </div>
                <button id="adminLoginBtn" class="btn">Log Masuk</button>
                <button id="backBtn" class="btn btn-secondary">Kembali</button>
                <p id="message" class="message error"></p>
            `;
            document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
            document.getElementById('backBtn').addEventListener('click', renderRoleSelectionScreen);
        }

        function renderAdminDashboard() {
            appContainer.innerHTML = `
                <h2>Papan Pemuka Admin</h2>
                <p>Pilih fail Excel (.xlsx) yang mengandungi data pelajar untuk dimuat naik.</p>
                <div class="form-group">
                    <label for="excelFile">Fail Data Pelajar</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="border: none;">
                </div>
                <button id="uploadBtn" class="btn">Muat Naik Data Pelajar</button>
                <button id="logoutBtn" class="btn btn-secondary">Log Keluar</button>
                <p id="message" class="message"></p>
            `;
            document.getElementById('uploadBtn').addEventListener('click', handleUploadData);
            document.getElementById('logoutBtn').addEventListener('click', renderRoleSelectionScreen);
        }

        function renderTopCommitteeEvaluationScreen() {
            const { topCommitteeMembers } = evaluationState;
            let tableRows = topCommitteeMembers.map(member => `
                <tr>
                    <td>
                        <strong>${member.namaPelajar}</strong><br>
                        <small>${member.AJK}</small>
                    </td>
                    <td>
                        <div class="rating-group" data-member-id="${member.noKP}">
                            ${[1,2,3,4,5].map(n => `<button class="btn">${n}</button>`).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');

            appContainer.innerHTML = `
                <h2>Langkah 1: Penilaian Jawatankuasa Tertinggi</h2>
                
                <div class="criteria-box">
                    <p><strong>Skala Penilaian:</strong></p>
                    <p><strong>1 (Sangat Lemah):</strong> Gagal memimpin, organisasi lemah, komunikasi tidak berkesan.</p>
                    <p><strong>2 (Lemah):</strong> Arah tuju kurang jelas, pengurusan kurang memuaskan.</p>
                    <p><strong>3 (Sederhana):</strong> Mampu menguruskan program pada tahap asas.</p>
                    <p><strong>4 (Baik):</strong> Kepimpinan yang baik, program terurus, dan komunikasi jelas.</p>
                    <p><strong>5 (Cemerlang):</strong> Kepimpinan luar biasa, pengurusan teratur, proaktif, dan telus.</p>
                </div>

                <table class="evaluation-table">${tableRows}</table>
                <button id="nextStepBtn" class="btn">Seterusnya</button>
                <p id="message" class="message error"></p>
            `;
             
            const table = appContainer.querySelector('.evaluation-table');
            table.addEventListener('click', handleRatingClick);
            document.getElementById('nextStepBtn').addEventListener('click', handleTopCommitteeSubmit);
        }

        function renderOwnCommitteeEvaluationScreen() {
            // Logik untuk paparan Langkah 2 (akan dibina)
            appContainer.innerHTML = `
                <h2>Langkah 2: Penilaian Rakan AJK</h2>
                <h3>Ini adalah bahagian penilaian rakan AJK sendiri (dalam pembinaan).</h3>
                <button id="finishBtn" class="btn">Selesai</button>
            `;
             document.getElementById('finishBtn').addEventListener('click', renderCompletionScreen);
        }

        function renderCompletionScreen() {
             appContainer.innerHTML = `
                <h2>Terima Kasih!</h2>
                <h3>Penilaian anda telah berjaya direkodkan.</h3>
                <button id="logoutBtn" class="btn">Log Keluar</button>
            `;
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.clear();
                renderRoleSelectionScreen();
            });
        }
        
        // =================================================================================
        // FUNGSI-FUNGSI PENGENDALI (HANDLER)
        // =================================================================================
        async function handleStudentLogin() {
            const noKPInput = document.getElementById('noKP').value.replace(/-/g, '').trim();
            const message = document.getElementById('message');
            
            if (!noKPInput) {
                message.textContent = "Sila masukkan No. Kad Pengenalan.";
                message.style.display = 'block';
                return;
            }
            
            console.log(`Mencuba log masuk dengan No. KP: [${noKPInput}]`);

            try {
                const docRef = doc(db, "pelajar", noKPInput);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("Pelajar ditemui:", docSnap.data());
                    const userFound = docSnap.data();
                    sessionStorage.setItem('loggedInUser', JSON.stringify(userFound));
                    await startEvaluationFlow(userFound);
                } else {
                    console.error(`Pelajar dengan No. KP [${noKPInput}] tidak ditemui dalam Firestore.`);
                    message.textContent = "No. Kad Pengenalan tidak wujud dalam rekod.";
                    message.style.display = 'block';
                }
            } catch (error) {
                console.error("Ralat semasa log masuk: ", error);
                message.textContent = "Gagal berhubung dengan pangkalan data.";
                message.style.display = 'block';
            }
        }
        
        function handleAdminLogin() {
            const pass = document.getElementById('adminPass').value;
            const message = document.getElementById('message');
            const ADMIN_PASSWORD = "admin123";

            if (pass === ADMIN_PASSWORD) {
                renderAdminDashboard();
            } else {
                message.textContent = "Kata laluan salah.";
                message.style.display = 'block';
            }
        }
        
        async function handleUploadData() {
            const fileInput = document.getElementById('excelFile');
            const message = document.getElementById('message');
            const uploadBtn = document.getElementById('uploadBtn');

            if (fileInput.files.length === 0) {
                message.textContent = "Sila pilih fail Excel terlebih dahulu.";
                message.className = 'message error';
                message.style.display = 'block';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                uploadBtn.disabled = true;
                message.textContent = "Memproses dan memuat naik data... Sila tunggu...";
                message.className = 'message';
                message.style.display = 'block';

                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    
                    if (jsonData.length === 0) throw new Error("Fail Excel kosong.");

                    const collectionRef = collection(db, "pelajar");
                    let count = 0;
                    console.log("--- Memulakan Proses Muat Naik ---");
                    for (const student of jsonData) {
                        const noKP = String(student["No. KP"] || '').replace(/[^0-9]/g, '').trim();
                        
                        if (!noKP) {
                            console.warn("Baris dilangkau kerana No. KP kosong:", student);
                            continue;
                        }
                        
                        console.log(`Memuat naik data untuk No. KP (ID Dokumen): [${noKP}]`);

                        const studentDoc = {
                            namaPelajar: String(student["Nama Pelajar"] || "").trim(),
                            noKP,
                            aGiliran: String(student["A. Giliran"] || '').trim(),
                            kelas: String(student["Kelas"] || "").trim(),
                            kumpulan: String(student["Kumpulan"] || "").trim(),
                            AJK: String(student["AJK"] || "").trim()
                        };
                        await setDoc(doc(collectionRef, noKP), studentDoc);
                        count++;
                    }
                    console.log("--- Proses Muat Naik Selesai ---");
                    message.textContent = `Selesai! ${count} rekod pelajar berjaya dimuat naik.`;
                    message.className = 'message success';
                } catch (error) {
                    console.error("Ralat memuat naik:", error);
                    if (error.code === 'permission-denied') {
                        message.textContent = 'Gagal: Akses ke pangkalan data disekat. Sila semak "Rules" di Firebase anda.';
                    } else {
                        message.textContent = `Gagal memuat naik. Sila semak format fail atau konsol untuk butiran.`;
                    }
                    message.className = 'message error';
                } finally {
                    uploadBtn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function startEvaluationFlow(currentUser) {
            appContainer.innerHTML = `<h2>Memuatkan data penilaian...</h2>`;
            const allStudents = await fetchAllStudents();
            if(!allStudents) {
                appContainer.innerHTML = `<h2>Gagal memuatkan data. Sila cuba lagi.</h2>`;
                return;
            }

            const topCommitteeRoles = ["PENGERUSI", "NAIB PENGERUSI", "SETIAUSAHA", "BENDAHARI"];
            evaluationState.currentUser = currentUser;
            evaluationState.allStudents = allStudents;
            evaluationState.topCommitteeMembers = allStudents.filter(s => topCommitteeRoles.includes(s.AJK));
            evaluationState.userCommitteeMembers = allStudents.filter(s => s.AJK === currentUser.AJK && s.noKP !== currentUser.noKP);
            evaluationState.currentQuestionIndex = 0;
            evaluationState.answers = { topCommittee: {}, ownCommittee: {} };

            renderTopCommitteeEvaluationScreen();
        }

        function handleRatingClick(event) {
            if (!event.target.matches('.rating-group .btn')) return;

            const clickedButton = event.target;
            const ratingGroup = clickedButton.parentElement;
            const memberId = ratingGroup.dataset.memberId;
            const score = parseInt(clickedButton.textContent, 10);

            ratingGroup.querySelectorAll('.btn').forEach(btn => btn.classList.remove('selected'));
            clickedButton.classList.add('selected');

            evaluationState.answers.topCommittee[memberId] = score;
            console.log(`Rating dikemas kini untuk ${memberId}: ${score}`);
        }
        
        async function handleTopCommitteeSubmit() {
            const { topCommitteeMembers, answers, currentUser } = evaluationState;
            const message = document.getElementById('message');

            if (Object.keys(answers.topCommittee).length < topCommitteeMembers.length) {
                message.textContent = "Sila berikan penilaian kepada semua ahli Jawatankuasa Tertinggi.";
                message.style.display = 'block';
                return;
            }
            
            message.style.display = 'none';

            try {
                const docRef = doc(db, "penilaian", currentUser.noKP);
                await setDoc(docRef, { 
                    penilai: { noKP: currentUser.noKP, nama: currentUser.namaPelajar },
                    penilaianJKT: answers.topCommittee 
                }, { merge: true });

                console.log("Penilaian JKT berjaya disimpan ke Firebase.");
                renderOwnCommitteeEvaluationScreen();

            } catch (error) {
                console.error("Ralat menyimpan penilaian JKT:", error);
                message.textContent = "Gagal menyimpan data penilaian. Sila cuba lagi.";
                message.style.display = 'block';
            }
        }
        
        async function fetchAllStudents() {
            try {
                const querySnapshot = await getDocs(collection(db, "pelajar"));
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                console.error("Ralat mendapatkan semua pelajar: ", error);
                return null;
            }
        }

        // =================================================================================
        // MULAKAN APLIKASI
        // =================================================================================
        renderRoleSelectionScreen();
    </script>
</body>
</html>

