<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Penilaian Rakan Sebaya</title>
    <!-- 1. FONT DARI GOOGLE FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Pustaka untuk membaca fail Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- 2. GAYA CSS TERUS DI DALAM HTML -->
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --label-color: #555;
            --border-color: #ccc;
            --error-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }

        #app {
            width: 100%;
            max-width: 600px; /* Lebarkan sedikit untuk jadual penilaian */
            background-color: var(--card-background);
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease-in-out;
        }
        
        h1, h2, h3 {
            text-align: center;
            color: var(--text-color);
            margin-top: 0;
            font-weight: 700;
        }
        
        h2 { margin-bottom: 0.5rem; }
        h3 { margin-bottom: 1.5rem; font-weight: 400; color: var(--label-color); }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--label-color);
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }

        .form-group input[type="file"] {
            padding: 0.5rem;
        }

        .btn {
            width: 100%;
            padding: 0.9rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }
        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }

        .btn:disabled {
            background-color: #cdd2d7;
            cursor: not-allowed;
        }
        
        .message {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            display: none;
        }
        .message.error {
            color: var(--error-color);
            background-color: rgba(220, 53, 69, 0.1);
        }
        .message.success {
            color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.1);
        }

        /* Gaya untuk Jadual Penilaian */
        .evaluation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        .evaluation-table th, .evaluation-table td {
            text-align: left;
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
        }
        .evaluation-table th {
            font-weight: 500;
            color: var(--label-color);
        }
        .rating-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .rating-group .btn {
            flex: 1; 
            background-color: #e9ecef; 
            color: var(--secondary-color);
            border: 1px solid #dee2e6;
            margin-top: 0;
        }
        .rating-group .btn:hover {
            background-color: #dde2e7; 
        }
        .rating-group .btn.selected {
            background-color: var(--primary-color); 
            color: white;
            border-color: var(--primary-color);
        }
        
        .criteria-box {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .criteria-box p {
            margin: 0 0 0.5rem 0;
        }
        .criteria-box p:last-child {
            margin-bottom: 0;
        }
        .criteria-box strong {
            color: var(--text-color);
        }

    </style>
</head>
<body>
    
    <div id="app">
        <!-- Kandungan aplikasi akan dimuatkan di sini -->
    </div>

    <!-- 3. SKRIP FIREBASE DAN LOGIK APLIKASI -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDoc, doc, setDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-analytics.js";

        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAVDe2JccI_u6yIdgtDHHmOVMnqfzc7oDA",
            authDomain: "penilaian-ajk.firebaseapp.com",
            projectId: "penilaian-ajk",
            storageBucket: "penilaian-ajk.appspot.com",
            messagingSenderId: "409815374539",
            appId: "1:409815374539:web:e66da87200f959ae9d594e",
            measurementId: "G-T7KZYS3W0Y"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        console.log("Firebase berjaya dihubungkan dengan projek 'penilaian-ajk'!");

        const appContainer = document.getElementById('app');
        
        let evaluationState = {};

        // =================================================================================
        // SENARAI AJK DAN SOALAN
        // =================================================================================
        const committeeList = [
            "AJK PROGRAM", "AJK PROTOKOL", "AJK AKTIVITI", "AJK TEKNIKAL & SIARAYA",
            "AJK TUGAS-TUGAS KHAS", "AJK KESELAMATAN & KEBAJIKAN", "AJK PENGANGKUTAN",
            "AJK HADIAH & CENDERAHATI", "AJK JAMUAN", "AJK DOKUMENTASI & PUBLISITI"
        ];
        
        const topCommitteeRoles = ["PENGERUSI", "NAIB PENGERUSI", "SETIAUSAHA", "BENDAHARI"];

        const evaluationQuestions = [
            "Sejauh manakah ahli ini terlibat secara aktif dalam sesi perbincangan dan menyumbang kepada perancangan tugas AJK?",
            "Adakah ahli ini menunjukkan inisiatif dalam mencadangkan idea atau mengambil tanggungjawab tanpa perlu disuruh?",
            "Sejauh manakah ahli ini berkomunikasi dengan jelas dan berkesan dengan ahli lain semasa fasa perancangan?",
            "Adakah ahli ini melaksanakan tugas yang diamanahkan dengan cekap dan penuh tanggungjawab semasa aktiviti berlangsung?",
            "Sejauh manakah keupayaan ahli ini untuk kekal tenang dan membantu menyelesaikan sebarang masalah yang timbul secara tiba-tiba?",
            "Adakah ahli ini bekerjasama dengan baik, sedia membantu rakan lain, dan mengekalkan komunikasi yang positif?",
            "Adakah ahli ini menunjukkan sikap yang positif dan menjadi pendorong semangat kepada ahli AJK yang lain?",
            "Adakah ahli ini turut serta dan komited dalam menyelesaikan tugasan selepas aktiviti (cth: mengemas)?",
            "Sejauh manakah ahli ini menyumbang dalam sesi post-mortem serta terbuka untuk memberi dan menerima maklum balas?"
        ];

        // =================================================================================
        // FUNGSI-FUNGSI PAPARAN (RENDER)
        // =================================================================================
        function renderRoleSelectionScreen() {
            appContainer.innerHTML = `
                <h1>Selamat Datang</h1>
                <h2>Sila pilih peranan anda:</h2>
                <button id="studentBtn" class="btn">Saya Pelajar</button>
                <button id="adminBtn" class="btn btn-secondary">Saya Admin</button>
            `;
            document.getElementById('studentBtn').addEventListener('click', renderStudentLoginScreen);
            document.getElementById('adminBtn').addEventListener('click', renderAdminLoginScreen);
        }

        function renderStudentLoginScreen() {
            appContainer.innerHTML = `
                <h2>Log Masuk Pelajar</h2>
                <div class="form-group">
                    <label for="noKP">No. Kad Pengenalan (tanpa '-')</label>
                    <input type="text" id="noKP" placeholder="Contoh: 980101101234">
                </div>
                <button id="loginBtn" class="btn">Log Masuk</button>
                <button id="backBtn" class="btn btn-secondary">Kembali</button>
                <p id="message" class="message error"></p>
            `;
            document.getElementById('loginBtn').addEventListener('click', handleStudentLogin);
            document.getElementById('backBtn').addEventListener('click', renderRoleSelectionScreen);
        }
        
        function renderAdminLoginScreen() {
             appContainer.innerHTML = `
                <h2>Log Masuk Admin</h2>
                <div class="form-group">
                    <label for="adminPass">Kata Laluan</label>
                    <input type="password" id="adminPass">
                </div>
                <button id="adminLoginBtn" class="btn">Log Masuk</button>
                <button id="backBtn" class="btn btn-secondary">Kembali</button>
                <p id="message" class="message error"></p>
            `;
            document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
            document.getElementById('backBtn').addEventListener('click', renderRoleSelectionScreen);
        }

        function renderAdminDashboard() {
            appContainer.innerHTML = `
                <h2>Papan Pemuka Admin</h2>
                <div class="form-group">
                    <label for="excelFile">Fail Data Pelajar</label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="border: none;">
                </div>
                <button id="uploadBtn" class="btn">Muat Naik Data Pelajar</button>
                <hr style="margin: 2rem 0; border: 1px solid #eee;">
                <button id="viewResultsBtn" class="btn">Lihat Keputusan Penilaian</button>
                <button id="logoutBtn" class="btn btn-secondary">Log Keluar</button>
                <p id="message" class="message"></p>
            `;
            document.getElementById('uploadBtn').addEventListener('click', handleUploadData);
            document.getElementById('viewResultsBtn').addEventListener('click', renderResultsScreen);
            document.getElementById('logoutBtn').addEventListener('click', renderRoleSelectionScreen);
        }

        function renderCommitteeSelectionScreen(currentUser) {
            const options = committeeList.map(ajk => `<option value="${ajk}">${ajk}</option>`).join('');
            appContainer.innerHTML = `
                <h2>Selamat Datang, ${currentUser.namaPelajar}!</h2>
                <h3>Sila pilih jawatankuasa (AJK) anda untuk meneruskan.</h3>
                <div class="form-group">
                    <label for="committeeSelect">Pilih AJK</label>
                    <select id="committeeSelect">
                        <option value="" disabled selected>-- Sila Pilih --</option>
                        ${options}
                    </select>
                </div>
                <button id="saveCommitteeBtn" class="btn">Simpan & Teruskan</button>
                <p id="message" class="message error"></p>
            `;
            document.getElementById('saveCommitteeBtn').addEventListener('click', handleCommitteeSelection);
        }

        function renderTopCommitteeEvaluationScreen() {
            const { topCommitteeMembers } = evaluationState;
            let tableRows = topCommitteeMembers.map(member => `
                <tr>
                    <td>
                        <strong>${member.namaPelajar}</strong><br>
                        <small>${member.AJK}</small>
                    </td>
                    <td>
                        <div class="rating-group" data-member-id="${member.noKP}">
                            ${[1,2,3,4,5].map(n => `<button class="btn">${n}</button>`).join('')}
                        </div>
                    </td>
                </tr>
            `).join('');

            appContainer.innerHTML = `
                <h2>Langkah 1: Penilaian Jawatankuasa Tertinggi</h2>
                
                <div class="criteria-box">
                    <p><strong>Skala Penilaian:</strong></p>
                    <p><strong>1 (Sangat Lemah):</strong> Gagal memimpin, organisasi lemah, komunikasi tidak berkesan.</p>
                    <p><strong>2 (Lemah):</strong> Arah tuju kurang jelas, pengurusan kurang memuaskan.</p>
                    <p><strong>3 (Sederhana):</strong> Mampu menguruskan program pada tahap asas.</p>
                    <p><strong>4 (Baik):</strong> Kepimpinan yang baik, program terurus, dan komunikasi jelas.</p>
                    <p><strong>5 (Cemerlang):</strong> Kepimpinan luar biasa, pengurusan teratur, proaktif, dan telus.</p>
                </div>

                <table class="evaluation-table">${tableRows}</table>
                <button id="nextStepBtn" class="btn">Seterusnya</button>
                <p id="message" class="message error"></p>
            `;
             
            const table = appContainer.querySelector('.evaluation-table');
            table.addEventListener('click', handleRatingClick);
            document.getElementById('nextStepBtn').addEventListener('click', handleTopCommitteeSubmit);
        }

        function renderPeerQuestionScreen() {
            const { userCommitteeMembers, currentQuestionIndex, currentUser } = evaluationState;
            const question = evaluationQuestions[currentQuestionIndex];
            
            if (userCommitteeMembers.length === 0) {
                console.log("Tiada rakan AJK untuk dinilai. Melengkapkan penilaian...");
                handleFinalSubmit(); 
                return;
            }

            let tableRows = userCommitteeMembers.map(member => {
                const savedScore = evaluationState.answers.ownCommittee[currentQuestionIndex]?.[member.noKP];
                const ratingButtons = [1,2,3,4,5].map(n => 
                    `<button class="btn ${savedScore === n ? 'selected' : ''}">${n}</button>`
                ).join('');

                return `
                    <tr>
                        <td><strong>${member.namaPelajar}</strong></td>
                        <td>
                            <div class="rating-group" data-member-id="${member.noKP}">
                                ${ratingButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            const isFirstQuestion = currentQuestionIndex === 0;
            const isLastQuestion = currentQuestionIndex === evaluationQuestions.length - 1;

            appContainer.innerHTML = `
                <h2>Langkah 2: Penilaian Rakan AJK (${currentUser.AJK})</h2>
                <h3>Soalan ${currentQuestionIndex + 1} daripada ${evaluationQuestions.length}</h3>
                
                <div class="criteria-box">
                    <p><strong>Soalan:</strong></p>
                    <p>${question}</p>
                </div>

                <table class="evaluation-table">${tableRows}</table>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button id="prevBtn" class="btn btn-secondary" ${isFirstQuestion ? 'disabled' : ''}>Sebelumnya</button>
                    <button id="nextBtn" class="btn">${isLastQuestion ? 'Hantar Penilaian' : 'Seterusnya'}</button>
                </div>
                <p id="message" class="message error"></p>
            `;
            
            appContainer.querySelector('.evaluation-table').addEventListener('click', handlePeerRatingClick);
            document.getElementById('nextBtn').addEventListener('click', handleNextQuestion);
            if (!isFirstQuestion) {
                document.getElementById('prevBtn').addEventListener('click', handlePrevQuestion);
            }
        }

        function renderCompletionScreen() {
             appContainer.innerHTML = `
                <h2>Terima Kasih!</h2>
                <h3>Penilaian anda telah berjaya direkodkan. Anda boleh log keluar sekarang.</h3>
                <button id="logoutBtn" class="btn">Log Keluar</button>
            `;
            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.clear();
                renderRoleSelectionScreen();
            });
        }

        async function renderResultsScreen() {
            appContainer.innerHTML = `<h2>Memuat turun dan memproses keputusan...</h2>`;
            
            try {
                const evaluationsSnapshot = await getDocs(collection(db, "penilaian"));
                const evaluations = evaluationsSnapshot.docs.map(doc => doc.data());

                const studentsSnapshot = await getDocs(collection(db, "pelajar"));
                const students = studentsSnapshot.docs.map(doc => doc.data());
                
                if (evaluations.length === 0) {
                    appContainer.innerHTML = `
                        <h2>Tiada Keputusan Ditemui</h2>
                        <p>Belum ada pelajar yang menghantar penilaian.</p>
                        <button id="backBtn" class="btn btn-secondary">Kembali</button>
                    `;
                    document.getElementById('backBtn').addEventListener('click', renderAdminDashboard);
                    return;
                }

                const { topCommitteeResults, peerResults } = processEvaluationData(evaluations, students);
                
                const uniqueCommittees = [...new Set(students.filter(s => s.AJK && !topCommitteeRoles.includes(s.AJK)).map(s => s.AJK))];
                let filterOptions = uniqueCommittees.map(ajk => `<option value="${ajk}">${ajk}</option>`).join('');

                let topCommitteeHtml = Object.values(topCommitteeResults).map(res => `
                    <tr>
                        <td><strong>${res.nama}</strong><br><small>${res.ajk}</small></td>
                        <td>${res.totalVotes}</td>
                        <td>${res.average.toFixed(2)}</td>
                    </tr>
                `).join('');
                
                let peerResultsHtml = Object.values(peerResults).map(res => `
                    <tr>
                        <td><strong>${res.nama}</strong><br><small>${res.ajk}</small></td>
                        <td>${res.totalVotes}</td>
                        <td>${res.average.toFixed(2)}</td>
                    </tr>
                `).join('');

                appContainer.innerHTML = `
                    <h2>Keputusan Penilaian</h2>
                    <button id="downloadXlsxBtn" class="btn">Muat Turun Laporan (Excel)</button>
                    
                    <h3 style="margin-top: 2rem; text-align: left;">Keputusan Jawatankuasa Tertinggi</h3>
                    <table class="evaluation-table">
                        <thead><tr><th>Nama</th><th>Jumlah Undi</th><th>Purata Skor</th></tr></thead>
                        <tbody>${topCommitteeHtml}</tbody>
                    </table>

                    <h3 style="margin-top: 2rem; text-align: left;">Keputusan Penilaian Rakan AJK</h3>
                    
                    <div class="form-group" style="margin-top: 1rem;">
                        <label for="ajkFilter">Tapis Mengikut AJK:</label>
                        <select id="ajkFilter">
                            <option value="semua">Semua AJK</option>
                            ${filterOptions}
                        </select>
                    </div>

                    <table class="evaluation-table" id="peerResultsTable">
                         <thead><tr><th>Nama</th><th>Jumlah Undian Diterima</th><th>Purata Skor Keseluruhan</th></tr></thead>
                        <tbody>${peerResultsHtml}</tbody>
                    </table>

                    <button id="backBtn" class="btn btn-secondary">Kembali ke Papan Pemuka</button>
                `;
                document.getElementById('backBtn').addEventListener('click', renderAdminDashboard);
                document.getElementById('downloadXlsxBtn').addEventListener('click', () => downloadResultsAsXlsx(evaluations, students));
                document.getElementById('ajkFilter').addEventListener('change', (event) => handleAjkFilterChange(event, peerResults));

            } catch (error) {
                console.error("Ralat memaparkan keputusan:", error);
                appContainer.innerHTML = `
                    <h2>Gagal Memaparkan Keputusan</h2>
                    <p>Sila semak konsol untuk maklumat ralat.</p>
                    <button id="backBtn" class="btn btn-secondary">Kembali</button>
                `;
                document.getElementById('backBtn').addEventListener('click', renderAdminDashboard);
            }
        }
        
        // =================================================================================
        // FUNGSI-FUNGSI PENGENDALI (HANDLER)
        // =================================================================================
        async function handleStudentLogin() {
            const noKPInput = document.getElementById('noKP').value.replace(/-/g, '').trim();
            const message = document.getElementById('message');
            
            if (!noKPInput) {
                message.textContent = "Sila masukkan No. Kad Pengenalan.";
                message.style.display = 'block';
                return;
            }
            
            try {
                // Langkah 1: Semak jika pelajar wujud
                const studentDocRef = doc(db, "pelajar", noKPInput);
                const studentDocSnap = await getDoc(studentDocRef);

                if (!studentDocSnap.exists()) {
                    message.textContent = "No. Kad Pengenalan tidak wujud dalam rekod.";
                    message.style.display = 'block';
                    return;
                }
                
                const userFound = studentDocSnap.data();
                sessionStorage.setItem('loggedInUser', JSON.stringify(userFound));

                // Langkah 2: Semak jika AJK kosong
                if (!userFound.AJK || userFound.AJK.trim() === "") {
                    console.log("AJK belum dipilih. Memaparkan skrin pemilihan.");
                    renderCommitteeSelectionScreen(userFound);
                    return; 
                }

                // Langkah 3: Jika AJK sudah ada, semak status penilaian
                const evaluationDocRef = doc(db, "penilaian", noKPInput);
                const evaluationDocSnap = await getDoc(evaluationDocRef);

                if (evaluationDocSnap.exists() && evaluationDocSnap.data().penilaianAJK) {
                    console.log("Pengguna ini telah melengkapkan penilaian. Terus ke skrin selesai.");
                    renderCompletionScreen();
                } else {
                    console.log("Memulakan aliran penilaian.");
                    await startEvaluationFlow(userFound);
                }

            } catch (error) {
                console.error("Ralat semasa log masuk: ", error);
                message.textContent = "Gagal berhubung dengan pangkalan data.";
                message.style.display = 'block';
            }
        }
        
        function handleAdminLogin() {
            const pass = document.getElementById('adminPass').value;
            const message = document.getElementById('message');
            const ADMIN_PASSWORD = "admin123";

            if (pass === ADMIN_PASSWORD) {
                renderAdminDashboard();
            } else {
                message.textContent = "Kata laluan salah.";
                message.style.display = 'block';
            }
        }
        
        async function handleUploadData() {
            const fileInput = document.getElementById('excelFile');
            const message = document.getElementById('message');
            const uploadBtn = document.getElementById('uploadBtn');

            if (fileInput.files.length === 0) {
                message.textContent = "Sila pilih fail Excel terlebih dahulu.";
                message.className = 'message error';
                message.style.display = 'block';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async function(event) {
                uploadBtn.disabled = true;
                message.textContent = "Memproses dan memuat naik data... Sila tunggu...";
                message.className = 'message';
                message.style.display = 'block';

                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    
                    if (jsonData.length === 0) throw new Error("Fail Excel kosong.");

                    const collectionRef = collection(db, "pelajar");
                    let count = 0;
                    for (const student of jsonData) {
                        const noKP = String(student["No. KP"] || '').replace(/[^0-9]/g, '').trim();
                        if (!noKP) continue;
                        
                        // [LOGIK DIPERBAIKI] Kekalkan JKT, kosongkan yang lain
                        const studentAJK = String(student["AJK"] || "").trim().toUpperCase();
                        const finalAJK = topCommitteeRoles.includes(studentAJK) ? studentAJK : "";

                        const studentDoc = {
                            namaPelajar: String(student["Nama Pelajar"] || "").trim(),
                            noKP,
                            aGiliran: String(student["A. Giliran"] || '').trim(),
                            kelas: String(student["Kelas"] || "").trim(),
                            kumpulan: String(student["Kumpulan"] || "").trim(),
                            AJK: finalAJK 
                        };
                        await setDoc(doc(collectionRef, noKP), studentDoc);
                        count++;
                    }
                    message.textContent = `Selesai! ${count} rekod pelajar berjaya dimuat naik.`;
                    message.className = 'message success';
                } catch (error) {
                    console.error("Ralat memuat naik:", error);
                    message.textContent = `Gagal memuat naik. Sila semak konsol untuk butiran.`;
                    message.className = 'message error';
                } finally {
                    uploadBtn.disabled = false;
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function handleCommitteeSelection() {
            const selectedAJK = document.getElementById('committeeSelect').value;
            const message = document.getElementById('message');
            if (!selectedAJK) {
                message.textContent = 'Sila pilih AJK anda.';
                message.style.display = 'block';
                return;
            }

            const currentUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
            const docRef = doc(db, "pelajar", currentUser.noKP);

            try {
                await updateDoc(docRef, { AJK: selectedAJK });
                currentUser.AJK = selectedAJK; // Kemas kini data dalam sesi
                sessionStorage.setItem('loggedInUser', JSON.stringify(currentUser));
                await startEvaluationFlow(currentUser);
            } catch (error) {
                console.error("Gagal menyimpan AJK:", error);
                message.textContent = "Gagal menyimpan pilihan AJK anda. Sila cuba lagi.";
                message.style.display = 'block';
            }
        }

        async function startEvaluationFlow(currentUser) {
            appContainer.innerHTML = `<h2>Memuatkan data penilaian...</h2>`;
            const allStudents = await fetchAllStudents();
            if(!allStudents) {
                appContainer.innerHTML = `<h2>Gagal memuatkan data. Sila cuba lagi.</h2>`;
                return;
            }

            evaluationState.currentUser = currentUser;
            evaluationState.allStudents = allStudents;
            
            evaluationState.topCommitteeMembers = allStudents.filter(s => topCommitteeRoles.includes(s.AJK) && s.noKP !== currentUser.noKP);
            evaluationState.userCommitteeMembers = allStudents.filter(s => s.AJK === currentUser.AJK && s.noKP !== currentUser.noKP);

            evaluationState.currentQuestionIndex = 0;
            evaluationState.answers = { topCommittee: {}, ownCommittee: {} };

            renderTopCommitteeEvaluationScreen();
        }

        function handleRatingClick(event) {
            if (!event.target.matches('.rating-group .btn')) return;

            const clickedButton = event.target;
            const ratingGroup = clickedButton.parentElement;
            const memberId = ratingGroup.dataset.memberId;
            const score = parseInt(clickedButton.textContent, 10);

            ratingGroup.querySelectorAll('.btn').forEach(btn => btn.classList.remove('selected'));
            clickedButton.classList.add('selected');

            evaluationState.answers.topCommittee[memberId] = score;
        }
        
        async function handleTopCommitteeSubmit() {
            const { topCommitteeMembers, answers, currentUser } = evaluationState;
            const message = document.getElementById('message');

            if (Object.keys(answers.topCommittee).length < topCommitteeMembers.length) {
                message.textContent = "Sila berikan penilaian kepada semua ahli Jawatankuasa Tertinggi.";
                message.style.display = 'block';
                return;
            }
            
            message.style.display = 'none';

            try {
                const docRef = doc(db, "penilaian", currentUser.noKP);
                await setDoc(docRef, { 
                    penilai: { noKP: currentUser.noKP, nama: currentUser.namaPelajar },
                    penilaianJKT: answers.topCommittee 
                }, { merge: true });
                renderPeerQuestionScreen();
            } catch (error) {
                message.textContent = "Gagal menyimpan data penilaian. Sila cuba lagi.";
                message.style.display = 'block';
            }
        }

        function handlePeerRatingClick(event) {
            if (!event.target.matches('.rating-group .btn')) return;

            const clickedButton = event.target;
            const ratingGroup = clickedButton.parentElement;
            const memberId = ratingGroup.dataset.memberId;
            const score = parseInt(clickedButton.textContent, 10);
            const questionIndex = evaluationState.currentQuestionIndex;

            ratingGroup.querySelectorAll('.btn').forEach(btn => btn.classList.remove('selected'));
            clickedButton.classList.add('selected');

            if (!evaluationState.answers.ownCommittee[questionIndex]) {
                evaluationState.answers.ownCommittee[questionIndex] = {};
            }
            evaluationState.answers.ownCommittee[questionIndex][memberId] = score;
        }

        function handleNextQuestion() {
            const { currentQuestionIndex, userCommitteeMembers, answers } = evaluationState;
            const message = document.getElementById('message');

            const currentAnswers = answers.ownCommittee[currentQuestionIndex] || {};
            if (Object.keys(currentAnswers).length < userCommitteeMembers.length) {
                message.textContent = 'Sila berikan penilaian kepada semua ahli untuk soalan ini.';
                message.style.display = 'block';
                return;
            }
            message.style.display = 'none';

            if (currentQuestionIndex === evaluationQuestions.length - 1) {
                handleFinalSubmit();
            } else {
                evaluationState.currentQuestionIndex++;
                renderPeerQuestionScreen();
            }
        }

        function handlePrevQuestion() {
            if (evaluationState.currentQuestionIndex > 0) {
                evaluationState.currentQuestionIndex--;
                renderPeerQuestionScreen();
            }
        }

        async function handleFinalSubmit() {
            appContainer.innerHTML = `<h2>Menyimpan semua data penilaian...</h2>`;
            const { answers, currentUser } = evaluationState;

            try {
                const docRef = doc(db, "penilaian", currentUser.noKP);
                await setDoc(docRef, { 
                    penilaianAJK: answers.ownCommittee 
                }, { merge: true });
                renderCompletionScreen();
            } catch (error) {
                appContainer.innerHTML = `
                    <h2>Gagal menyimpan data.</h2>
                    <p>Sila cuba lagi atau hubungi admin.</p>
                    <button id="retryBtn" class="btn">Cuba Semula</button>
                `;
                document.getElementById('retryBtn').addEventListener('click', handleFinalSubmit);
            }
        }
        
        async function fetchAllStudents() {
            try {
                const querySnapshot = await getDocs(collection(db, "pelajar"));
                return querySnapshot.docs.map(doc => doc.data());
            } catch (error) {
                return null;
            }
        }

        function handleAjkFilterChange(event, allPeerResults) {
            const selectedAjk = event.target.value;
            const tableBody = document.querySelector('#peerResultsTable tbody');

            let filteredResults;
            if (selectedAjk === 'semua') {
                filteredResults = Object.values(allPeerResults);
            } else {
                filteredResults = Object.values(allPeerResults).filter(res => res.ajk === selectedAjk);
            }

            const newTableBodyHtml = filteredResults.map(res => `
                <tr>
                    <td><strong>${res.nama}</strong><br><small>${res.ajk}</small></td>
                    <td>${res.totalVotes}</td>
                    <td>${res.average.toFixed(2)}</td>
                </tr>
            `).join('');

            tableBody.innerHTML = newTableBodyHtml;
        }


        function processEvaluationData(evaluations, students) {
            const results = {};
            students.forEach(s => {
                results[s.noKP] = { 
                    nama: s.namaPelajar, 
                    ajk: s.AJK,
                    jktScores: [],
                    peerScores: {} 
                };
            });

            evaluations.forEach(ev => {
                if (ev.penilaianJKT) {
                    for (const [memberId, score] of Object.entries(ev.penilaianJKT)) {
                        if (results[memberId]) results[memberId].jktScores.push(score);
                    }
                }
                if (ev.penilaianAJK) {
                    for (const [qIndex, answers] of Object.entries(ev.penilaianAJK)) {
                        for (const [memberId, score] of Object.entries(answers)) {
                            if (results[memberId]) {
                                if (!results[memberId].peerScores[qIndex]) results[memberId].peerScores[qIndex] = [];
                                results[memberId].peerScores[qIndex].push(score);
                            }
                        }
                    }
                }
            });

            const topCommitteeResults = {};
            const peerResults = {};

            for (const [studentId, data] of Object.entries(results)) {
                if (topCommitteeRoles.includes(data.ajk)) {
                    const totalScore = data.jktScores.reduce((a, b) => a + b, 0);
                    topCommitteeResults[studentId] = {
                        nama: data.nama, ajk: data.ajk,
                        totalVotes: data.jktScores.length,
                        average: data.jktScores.length ? totalScore / data.jktScores.length : 0
                    };
                } else {
                    let totalPeerScore = 0, totalPeerVotes = 0;
                    Object.values(data.peerScores).forEach(scores => {
                        totalPeerScore += scores.reduce((a, b) => a + b, 0);
                        totalPeerVotes += scores.length;
                    });
                    peerResults[studentId] = {
                        nama: data.nama, ajk: data.ajk,
                        totalVotes: totalPeerVotes,
                        average: totalPeerVotes ? totalPeerScore / totalPeerVotes : 0
                    };
                }
            }
            return { topCommitteeResults, peerResults };
        }

        function downloadResultsAsXlsx(evaluations, students) {
            const { topCommitteeResults, peerResults } = processEvaluationData(evaluations, students);
            const studentMap = new Map(students.map(s => [s.noKP, s.namaPelajar]));

            const summaryJKT = Object.values(topCommitteeResults).map(res => ({
                "Nama": res.nama, "Jawatan": res.ajk, "Jumlah Undi": res.totalVotes, "Purata Skor": res.average.toFixed(2)
            }));
            
            const summaryAJK = Object.values(peerResults).map(res => ({
                "Nama": res.nama, "AJK": res.ajk, "Jumlah Undian Diterima": res.totalVotes, "Purata Skor Keseluruhan": res.average.toFixed(2)
            }));

            let rawData = [];
            evaluations.forEach(ev => {
                const evaluatorKP = ev.penilai.noKP;
                const evaluatorName = ev.penilai.nama;
                if (ev.penilaianJKT) {
                    for (const [memberId, score] of Object.entries(ev.penilaianJKT)) {
                        rawData.push({
                            "Penilai_KP": evaluatorKP, "Penilai_Nama": evaluatorName,
                            "Dinilai_KP": memberId, "Dinilai_Nama": studentMap.get(memberId) || 'N/A',
                            "Jenis_Penilaian": "JKT", "Soalan_No": "N/A", "Skor": score
                        });
                    }
                }
                if (ev.penilaianAJK) {
                    for (const [qIndex, answers] of Object.entries(ev.penilaianAJK)) {
                        for (const [memberId, score] of Object.entries(answers)) {
                           rawData.push({
                                "Penilai_KP": evaluatorKP, "Penilai_Nama": evaluatorName,
                                "Dinilai_KP": memberId, "Dinilai_Nama": studentMap.get(memberId) || 'N/A',
                                "Jenis_Penilaian": "AJK", "Soalan_No": parseInt(qIndex) + 1, "Skor": score
                            });
                        }
                    }
                }
            });

            const ws_summary_jkt = XLSX.utils.json_to_sheet(summaryJKT);
            const ws_summary_ajk = XLSX.utils.json_to_sheet(summaryAJK);
            const ws_raw_data = XLSX.utils.json_to_sheet(rawData);

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws_summary_jkt, "Ringkasan JKT");
            XLSX.utils.book_append_sheet(wb, ws_summary_ajk, "Ringkasan AJK");
            XLSX.utils.book_append_sheet(wb, ws_raw_data, "Data Mentah Penilaian");

            XLSX.writeFile(wb, "Laporan_Penilaian_Lengkap.xlsx");
        }
        
        // =================================================================================
        // MULAKAN APLIKASI
        // =================================================================================
        renderRoleSelectionScreen();
    </script>
</body>
</html>

